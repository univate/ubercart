<?php
// $Id: uc_catalog.module,v 1.4 2007-05-08 21:13:23 rszrama Exp $

/**
 * @file
 * Ãœbercart Catalog module.
 * 
 * Provides classification and navigation product nodes using taxonomy. When 
 * installed, this module creates a vocabulary named "Product Catalog" and stores
 * the vocabulary id for future use. The user is responsible for maintaining the
 * terms in the taxonomy, though the Catalog will find products not listed in it.
 * 
 * Coded by Lyle Mantooth
 */

/******************************************************************************
 * Drupal Hooks                                                               *
 ******************************************************************************/

/**
 * Implementation of hook_menu().
 */
function uc_catalog_menu($may_cache){
  global $user;
  $items = array();

  if ($may_cache){
    $items[] = array(
      'path' => 'catalog',
      'access' => TRUE,
      'title' => t('Catalog'),
      'callback' => 'theme',
      'callback arguments' => 'uc_catalog_browse',
      'type' => MENU_NORMAL_ITEM,
    );
    $items[] = array('path' => 'admin/store/settings/catalog',
      'access' => user_access('administer catalog'),
      'title' => t('Catalog settings'),
      'callback' => 'uc_catalog_admin_settings',
      'type' => MENU_NORMAL_ITEM,
    );
    $items[] = array('path' => 'admin/store/products/orphans',
      'title' => t('Find orphaned products'),
      'access' => user_access('administer catalog'),
      'callback' => 'uc_catalog_orphaned_products',
      'description' => t('Find products that have not been categorized.'),
      'type' => MENU_NORMAL_ITEM,
      'weight' => -4
    );
    if (module_exists('ubrowser')){
      $items[] = array('path' => 'admin/store/products/categories',
        'access' => user_access('administer catalog'),
        'title' => t('Move products'),
        'callback' => 'drupal_get_form',
        'callback arguments' => 'uc_catalog_set_category_form',
        'type' => MENU_NORMAL_ITEM,
        'weight' => -6,
      );
    }
  }
  
  return $items;
}

/**
 * Implementation of hook_perm().
 */
function uc_catalog_perm(){
  return array('administer catalog');
}

/**
 * Implementation of hook_nodeapi().
 */
function uc_catalog_nodeapi(&$node, $op, $a3 = null, $a4 = null){
  if (in_array($node->type, uc_catalog_node_types())){
    switch($op){
      case 'view':
        $terms = taxonomy_node_get_terms_by_vocabulary($node->nid, variable_get('uc_catalog_vid', 0));
        if (count($terms)){
          $crumbs = array(l(t('Catalog'), 'catalog'));
          foreach ($terms as $term){
            $crumbs[] = l($term->name, uc_catalog_term_path($term));
          }
        }
        drupal_set_breadcrumb($crumbs);
      break;
    }
  }
}

/**
 * Performs garbage collection when the module's vocabulary is deleted.
 */
function uc_catalog_taxonomy($op, $type, $object = null){
  switch($type){
    case 'vocabulary':
      switch($op){
        case 'delete':
          if ($object->vid == variable_get('uc_catalog_vid', 0)){
            variable_del('uc_catalog_vid');
          }
        break;
      }
    break;
    case 'term':
      switch($op){
        case 'insert':
          $field_name = 'image';
          if ($file = file_check_upload($field_name)) {
            $file->filepath = str_replace('\\', '/', $file->filepath);
            $file = file_save_upload($field_name, file_create_path('ubercart_images') .'/'. $file->filename);
            if ($file) {
              if (image_get_info($file->filepath)) {
                db_query("INSERT INTO {uc_catalog_images} (fid, tid, filename, filepath, filemime, filesize) VALUES (%d, %d, '%s', '%s', '%s', %d)",
                  db_next_id('{files}_fid'), $object['tid'], $file->filename, $file->filepath, $file->filemime, $file->filesize
                );
              }
              else{
                form_set_error($field_name, t('Uploaded file is not a valid image'));
                file_delete($file->filepath);
              }
            }
          }
        break;
        case 'update':
          $field_name = 'image';
          if ($file = file_check_upload($field_name)) {
            $file->filepath = str_replace('\\', '/', $file->filepath);
            $file = file_save_upload($field_name, file_create_path('ubercart_images') .'/'. $file->filename);
            if ($file) {
              if (image_get_info($file->filepath)) {
                db_query("DELETE FROM {uc_catalog_images} WHERE tid = %d", $object['tid']);
                db_query("INSERT INTO {uc_catalog_images} (fid, tid, filename, filepath, filemime, filesize) VALUES (%d, %d, '%s', '%s', '%s', %d)",
                  db_next_id('{files}_fid'), $object['tid'], $file->filename, $file->filepath, $file->filemime, $file->filesize
                );
              }
              else{
                form_set_error($field_name, t('Uploaded file is not a valid image'));
                file_delete($file->filepath);
              }
            }
          }
        break;
      }
    break;
  }
}

function uc_catalog_form_alter($form_id, &$form){
  if ($form_id == 'taxonomy_form_term' && $form['vid']['#value'] == variable_get('uc_catalog_vid', 0)){
    $form['#attributes'] = array("enctype" => "multipart/form-data");
    
    $form['name']['#weight'] = -1;
    $form['image'] = array('#type' => 'file',
      '#title' => t('Image'),
      '#weight' => 0,
    );
  }
}

/**
 * Implementation of hook_term_path().
 *
 * This hook rewrites taxonomy term links to point to the return value.
 */
function uc_catalog_term_path($term){
  static $parents = array();
  
  if (!isset($parents[$term->tid])){
    $parents[$term->tid] = taxonomy_get_parents_all($term->tid);
  }
  $path = '';
  //drupal_set_message('<pre>'. print_r($parents[$term->tid], true) .'</pre>');
  foreach (array_reverse($parents[$term->tid]) as $parent){
    $path .= '/'. urlencode(str_replace(' ', '_', strtolower($parent->name)));
  }
  return 'catalog'. $path /* . urlencode(str_replace(' ', '_', strtolower($term->name))) */;
}

/**
 * Displays a menu for navigating the "Product Catalog"
 */
function uc_catalog_block($op = 'list', $delta = 0, $edit = array()){
  switch($op){
    case 'list':
      return array(array('info' => t('Catalog')));
    case 'view':
      /**
       * Data structure to mimic Drupal's menu system.
       */
      class uc_treeNode {
        var $tid = 0;
        var $name = 'Catalog';
        var $children = array();
        var $depth = -1;
        
        function uc_treeNode($term = null){
          if ($term){
            $this->tid = $term->tid;
            $this->name = $term->name;
            $this->depth = $term->depth;
          }
        }
        
        /**
         * Determines if new child is an immediate descendant or not.
         *
         * This function is completely dependent on the structure of the array returned 
         * by taxonomy_get_tree(). Each element in the array knows it's depth in the tree
         * and the array is a preorder iteration of the logical tree structure. Therefore,
         * if the parameter is more than one level deeper than $this, it should be passed
         * to the last child of $this.
         */
        function add_child(&$child){
          if ($child->depth - $this->depth == 1){
            $this->children[] = $child;
          }
          else{
            $last_child =&$this->children[count($this->children)-1];
            $last_child->add_child($child);
          }
        }
      }
      // Get the vocabulary tree information.
      $vid = variable_get('uc_catalog_vid', 0);
      $tree = taxonomy_get_tree($vid);
      // Then convert it into an actual tree structure.
      $menu_tree = new uc_treeNode();
      $level = array();
      $curr_depth = -1;
      foreach ($tree as $knot){
        $knothole = new uc_treeNode($knot);
        // Begin at the root of the tree and find the proper place.
        $menu_tree->add_child($knothole);
      }
      // Now, create a structured menu, separate from Drupal's menu.
      $content .= '<ul class="menu">';
      foreach ($menu_tree->children as $branch){
        list($trash, $html) = _uc_catalog_navigation($branch);
        $content .= $html;
      }
      $content .= "</ul>";
      $block = array('subject' => l(t('Catalog'), 'catalog'), 'content' => $content);
      return $block;
  }
}

function uc_catalog_forms(){
  $products = db_query("SELECT nid FROM {uc_products}");

  while ($prodrow = db_fetch_object($products))
  {
    $forms['uc_catalog_buy_it_now_form_'. $prodrow->nid] = array('callback' => 'uc_catalog_buy_it_now_form');
  }

  return $forms;
}

/******************************************************************************
 * TAPIr Hooks                                                                *
 ******************************************************************************/
/* function uc_catalog_table_alter($table_id, $op, $args = null){
  if (isset($args['tid']) || $_GET['q'] == 'admin/store/settings/tables/uc_product_table' || $_GET['q'] == 'products'){
    switch ($table_id){
      case 'uc_product_table':
        switch ($op){
          case 'fields':
            $fields[] = array(
              'name' => 'add_to_cart',
              'title' => t('Add to cart'),
              'weight' => 10,
              'enabled' => false,
              'attributes' => array('nowrap' => 'nowrap'),
            );
          return $fields;
          case 'data':
            if ($tid = $args['tid']){
              $header = tapir_get_header('uc_product_table', $args);
              $order = substr(tablesort_sql($header), 10);
              if (empty($order)){
                $order = 'n.title';
              }
              $data = array();
              $sql = 'SELECT DISTINCT(n.nid), n.sticky, n.title, n.created FROM {node} n INNER JOIN {term_node} tn ON n.nid = tn.nid RIGHT JOIN {uc_products} AS p ON n.nid = p.nid WHERE tn.tid = %d AND n.status = 1 ORDER BY '. $order;
              $sql_count = 'SELECT COUNT(DISTINCT(n.nid)) FROM {node} n INNER JOIN {term_node} tn ON n.nid = tn.nid RIGHT JOIN {uc_products} AS p ON n.nid = p.nid WHERE tn.tid = %d AND n.status = 1';
              $sql = db_rewrite_sql($sql);
              $sql_count = db_rewrite_sql($sql_count);
              $result = pager_query($sql, variable_get('uc_product_default_nodes', 10), 0, $sql_count, $tid);
              while ($node = db_fetch_object($result)){
                $node = node_load($node->nid);
                $data['add_to_cart'][] = drupal_get_form('uc_catalog_buy_it_now_form_'. $node->nid, $node);
              }
            }
          return $data;
        }
      break;
    }
    }
} */

/******************************************************************************
 * Ãœbercart Hooks                                                             *
 ******************************************************************************/

/**
 * Implementation of Ãœbercart's hook_store_status().
 * 
 * Provides status information about the "Product Catalog" and products not listed in the catalog.
 */
function uc_catalog_store_status(){
  $statuses = array();
  $cat_id = variable_get('uc_catalog_vid', 0);
  $catalog = taxonomy_get_vocabulary($cat_id);
  if ($catalog){
    $statuses[] = array('status' => 'ok', 'title' => t('Catalog vocabulary'),
      'desc' => t('Vocabulary !name has been identified as the !uber catalog.', array('!name' => l($catalog->name, 'admin/content/taxonomy/'. $catalog->vid), '!uber' => '&Uuml;bercart'))
    );

    $excluded = 0;
    $result = db_query("SELECT DISTINCT * FROM {node} AS n LEFT JOIN {term_node} AS tn ON n.nid = tn.nid LEFT JOIN {vocabulary_node_types} AS vnt ON n.type = vnt.type WHERE n.type != 'image' AND tn.tid IS NULL AND vnt.vid = %d", $cat_id);
    $excluded = db_num_rows($result);
    if ($excluded){
      $statuses[] = array('status' => 'warning', 'title' => t('Unlisted Products'),
        'desc' => format_plural($excluded, 'There is 1 product not listed in the catalog.', 'There are @count products not listed in the catalog.')
          . t(' Products are listed by assigning a category from the Product Catalog vocabulary to them. ')
          . l(t('Find orphaned products here.'), 'admin/store/products/orphans'),
      );
    }
    else{
      $statuses[] = array('status' => 'ok', 'title' => t('Unlisted Products'),
        'desc' => t('All products are currently listed in the catalog.'),
      );
    }
  }
  else{
    $statuses[] = array('status' => 'error',
      'title' => t('Catalog vocabulary'),
      'desc' => t('No vocabulary has been recognized as the !uber catalog. Click ', array('!uber' => '&Uuml;bercart'))
        . l(t('here'), 'admin/store/catalog/setup'). t(' to set one up')
    );
  }
  return $statuses;
}

/******************************************************************************
 * Menu Callbacks                                                             *
 ******************************************************************************/

/**
 * Determines if the "Product Catalog" vocabulary has been set up.
 */
function uc_catalog_admin_settings(){
  $output = '';
  $vid = variable_get('uc_catalog_vid', null);
  if ($vid){
    $catalog = taxonomy_get_vocabulary($vid);
    $output .= t('Vocabulary %name is set as the product catalog. ', array('%name' => $catalog->name));
    //$output .= l(t('Build a term hierarchy for products there.'), 'admin/content/taxonomy/'. $vid .'/add/term');
    //drupal_set_message($output);
    $output .= l(t('View the catalog here.'), 'admin/content/taxonomy/'. $vid);
  }
  else{
    $output .= t('A catalog vocabulary has not been set up yet. To start one, click <a href="admin/store/catalog/setup">here.</a>');
  }
  
  $output .= drupal_get_form('uc_catalog_admin_form');
  
  return $output;
}

/**
 * Form to change the category of many nodes at once.
 */
function uc_catalog_set_category_form(){
  drupal_add_css(drupal_get_path('module', 'uc_catalog') .'/uc_catalog.css');
  drupal_add_css(drupal_get_path('module', 'uc_product') .'/uc_product.css');
  $settings = array(
    'div' => '#category-selector',
    'vid' => variable_get('uc_catalog_vid', 0),
    'filter' => implode(',', uc_product_get_product_types()),
    'search' => 'true',
    'nids' => 'true',
    'nodesg' => 'product',
    'nodepl' => 'products',
    'multi' => 'true',
    'close' => 'false',
    'select' => 'buffer_products("'. base_path() .'","'. file_create_url('') .'")',
  );
  $form['selector'] = array('#type' => 'markup',
    '#value' => ubrowser($settings, 'category-selector'),
  );
  $form['buffer'] = uc_product_buffer_form(func_get_args());
  $form['buffer']['#prefix'] = '<div class="product-buffer">';
  $form['buffer']['#suffix'] = '</div>';
  unset($form['buffer']['submit']);
  
  drupal_add_js(drupal_get_path('module', 'uc_product') .'/uc_product.js', 'module');

  $form['categories'] = taxonomy_form(variable_get('uc_catalog_vid', 0));
  $form['categories']['#title'] = t('New Category');
  unset($form['categories']['#weight']);
  $form['move'] = array('#type' => 'submit',
    '#value' => t('Move'),
  );
  $form['copy'] = array('#type' => 'submit',
    '#value' => t('Copy'),
  );
  
  return $form;
}

/**
 * Submit function for uc_catalog_set_category_form().
 */
function uc_catalog_set_category_form_submit($form_id, $form_values){
  $categories = $form_values['categories'];
  $catalog_vid = variable_get('uc_catalog_vid', 0);
  foreach(array_filter(explode('/', $form_values['products'])) as $nid){
    // Preserve terms already associated with this product.
    $terms = taxonomy_node_get_terms($nid);
    foreach ($terms as $term){
      // Don't preserve those from the catalog if products are being moved.
      if ($form_values['op'] == t('Move') && $term->vid == $catalog_vid){
        continue;
      }
      $categories[] = $term->tid;
    }
    taxonomy_node_save($nid, array_unique($categories));
  }
}

/**
 * Catalog taxonomy browser.
 *
 * URL is of the form 'catalog/category_name'.
 * The breadcrumb provides links to all ancestry paths to the current term.
 * A table of links provides access to the immediate children and grandchildren.
 * 
 * Inspired by taxonomy_term_page().
 *
 * @return
 *   A Drupal page providing links to products in this category, and nearby categories.
 */
function uc_catalog_get_page($path_terms){
  $catalog = new stdClass();
  $vid = variable_get('uc_catalog_vid', 0);
  $parent = 0;
  $term = null;
  foreach ($path_terms as $path){
    $terms = taxonomy_get_term_by_name(str_replace('_', ' ', urldecode($path)));
    $test = null;
    foreach ($terms as $test){
      if ($vid == $test->vid){
        $parents = taxonomy_get_parents($test->tid);
        //drupal_set_message('Parent: '. $parent);
        //drupal_set_message('<pre>'. print_r($parents, true) .'</pre>');
        if (is_null($term) || ($parent == 0 && empty($parents)) || in_array($parent, array_keys($parents))){
          $term = $test;
          break;
        }
      }
    }
    if ($term){
      $parent = $term->tid;
    }
  }
  if ($term){
    $tid = $term->tid;
    $name = $term->name;
  }
  else{
    $tid = 0;
    $name = t('Catalog');
  }
  $catalog->tid = $tid;
  $catalog->vid = $vid;
  $catalog->name = $name;
  $catalog->children = array();
  if (module_exists('imagecache') && $file = uc_catalog_image_load($catalog->tid)){
    $imagecache_path =  file_create_url(file_directory_path() .'/imagecache/category/'. $file->filepath);
    $info = image_get_info($imagecache_path);
    $catalog->image = $info;
    $catalog->image['filepath'] = $file->filepath;
  }
  $types = uc_catalog_node_types();
  $links = array();
  $child_list = array();
  $children = taxonomy_get_children($tid, $vid);
  foreach ($children as $child){
    $n = 0;
    foreach ($types as $type){
      $n += taxonomy_term_count_nodes($child->tid, $type);
    }
    $child->nodes = $n;
    // Display child category's image.
    if (module_exists('imagecache') && $file = uc_catalog_image_load($child->tid)){
      $imagecache_path =  file_create_url(file_directory_path() .'/imagecache/category/'. $file->filepath);
      $info = image_get_info($imagecache_path);
      $child->image = $info;
      $child->image['filepath'] = $file->filepath;
    }
    // Display list of child category's children categories.
    // If more than $max_gc_display, show "More..." link to child.
    $grandchildren_list = taxonomy_get_children($child->tid, $vid);
    $child->children = $grandchildren_list;
    $catalog->children[] = $child;
  }
  //$node_resource = taxonomy_select_nodes(array($tid));
  return $catalog;
}

function theme_uc_catalog_browse(){
  drupal_add_css(drupal_get_path('module', 'uc_catalog') .'/uc_catalog.css');
  
  $args = func_get_args();
  //drupal_set_message('<pre>'. print_r($args, true) .'</pre>');
  $output = '';
  $catalog = uc_catalog_get_page($args);
  if ($catalog->name != t('Catalog')) {
    drupal_set_title($catalog->name);
  }
  drupal_set_breadcrumb(uc_catalog_set_breadcrumb($catalog->tid));
  $types = uc_catalog_node_types();
  $links = array();
  $child_list = array();
  foreach ($catalog->children as $child){
    if ($child->nodes){
      $links[] = array('title' => $child->name .' ('. $child->nodes .')', 'href' => uc_catalog_term_path($child),
        'attributes' => array('rel' => 'tag'),
      );
    }
    if ($child->image){
      $image = '<div>';
      $image .= l(theme('imagecache', 'category', $child->image['filepath']), uc_catalog_term_path($child), array(), null, null, false, true);
      $image .= '</div>';
    }
    else{
      $image = '<div></div>';
    }
    $grandchildren = array();
    $j = 0;
    $max_gc_display = 3;
    foreach ($child->children as $i => $grandchild){
      if ($j >= $max_gc_display){
        break;
      }
      $g_child_nodes = 0;
      foreach ($types as $type){
        $g_child_nodes += taxonomy_term_count_nodes($grandchild->tid, $type);
      }
      if ($g_child_nodes){
        $grandchildren[$i] = l($grandchild->name, uc_catalog_term_path($grandchild));
        $j++;
      }
    }
    //$grandchildren = array_slice($grandchildren, 0, intval(count($grandchildren) / 2) + 1, true);
    if ($j > $max_gc_display){
      array_push($grandchildren, l('More...', uc_catalog_term_path($child)));
    }
    if ($child->nodes){
      $child_list[] = $image .'<br/><strong>'. l($child->name, uc_catalog_term_path($child)) .'</strong>'
        ."<br/><span>"
        . implode(', ', $grandchildren) ."</span>\n";
    }
  }
  if ($catalog->image){
    $output .= theme('imagecache', 'thumbnail', $catalog->image['filepath'], $catalog->name, $catalog->name, array('class' => 'category'));
  }
  $table_args = array('tid' => $catalog->tid, 'attributes' => array('id' => 'category-products'));
  $product_table = tapir_get_table('uc_product_table', $table_args);
  if (strpos($product_table, "<tbody>\n</tbody>") === false){ // If product table is not empty.
    $catalog->products = $product_table;
  }
  if ($catalog->products){
    if (count($links)){
      $output .= '>> ' . theme('links', $links, array('class' => 'links inline'));
    }
    $output .= $catalog->products;
    $output .= theme('pager');
  }
  else{
    // Display table of child categories similar to an osCommerce site's front page.
    $columns = 3; // could extract this number to a user-defined field
    $cat_rows = array();
    $row = array();
    $i = 1;
    foreach ($child_list as $cell){
      $row[] = array('data' => $cell, 'class' => 'category');
      if ($i % $columns == 0){
        $cat_rows[] = $row;
        $row = array();
      }
      $i++;
    }
    if (count($row) > 0 && count($row) < $columns){
      if (count($cat_rows) >= 1){
        $row = array_merge($row, array_fill(count($row), $columns - count($row), array('data' => '&nbsp;', 'class' => 'category')));
      }
      $cat_rows[] = $row;
    }
    $output .= theme('table', array(), $cat_rows, array('class' => 'category'));
  }
  
  return $output;
}

/******************************************************************************
 * Module Functions                                                           *
 ******************************************************************************/

/**
 * Returns an array of the node types that represent products in the catalog..
 */
function uc_catalog_node_types(){
  static $types;
  
  if (!isset($types)){
    // Get node types other than images.
    $result = db_query("SELECT type FROM {vocabulary_node_types} WHERE vid = %d", variable_get('uc_catalog_vid', 0));
    $types = array();
    while ($t = db_fetch_object($result)){
      if ($t->type != 'image'){
        $types[] = $t->type;
      }
    }
  }
  return $types;
}

/**
 * Catalog settings form.
 *
 * Configures the display of the catalog breadcrumb.
 */
function uc_catalog_admin_form(){
  $form = array();
  
  $vocabularies = taxonomy_get_vocabularies('product');
  foreach ($vocabularies as $vid => $vocabulary){
    $vocabs[$vid] = $vocabulary->name;
  }
  
  $form['uc_catalog_vid'] = array('#type' => 'select',
    '#title' => t('Catalog Vocabulary'),
    '#description' => t("The taxonomy vocabulary that will be considered the product catalog."),
    '#default_value' => variable_get('uc_catalog_vid', 0),
    '#options' => $vocabs,
  );
  
  $form['uc_catalog_breadcrumb'] = array('#type' => 'checkbox',
    '#title' => t('Display catalog breadcrumb'),
    '#default_value' => variable_get('uc_catalog_breadcrumb', true),
  );
  
  return system_settings_form($form);
}

function uc_catalog_buy_it_now_form($node){
  $form = array();
  $form['#base'] = 'uc_catalog_buy_it_now_form';
  $form['nid'] = array('#type' => 'hidden', '#value' => $node->nid);
  $form['submit'] = array('#type' => 'submit', '#value' =>  t('Add to cart'), );
  return $form;
}

function uc_catalog_buy_it_now_form_submit($form_id, $form_values){
  $node = node_load($form_values['nid']);
  $attributes = uc_product_get_attributes($node->nid);
  if (!empty($attributes)){
    drupal_set_message('This product has options that need to be selected before purchase. Please select them in the form below.');
    return drupal_get_path_alias('node/'. $form_values['nid']);
  }
  if (is_array($node->products)){
    foreach($node->products as $nid => $product){
      $attributes = uc_product_get_attributes($nid);
      if (!empty($attributes)){
        drupal_set_message('This product has options that need to be selected before purchase. Please select them in the form below.');
        return drupal_get_path_alias('node/'. $form_values['nid']);
      }
    }
  }
  return uc_cart_add_item($form_values['nid'], 1,  module_invoke_all('add_to_cart_data', $form_values));
}

/**
 * Formats the breadcrumb to the current term's ancestry.
 */
function uc_catalog_set_breadcrumb($tid, $is_node = false){
  static $breadcrumbs = array();
  static $terms = array();
  if (variable_get('uc_catalog_breadcrumb', true)){
    if (empty($breadcrumbs)){
      if ($tid != 0){
        $breadcrumbs[] = l(t('Catalog'), 'catalog');
      }
      else{
        $breadcrumbs[] = l(t('Home'), '');
      }
    }
    $parents = taxonomy_get_parents_all($tid);
    if (!$is_node){
      array_shift($parents);
    }
    while (count($parents)){
      $current = array_pop($parents);
      if (!in_array($current->tid, $terms)){
        $breadcrumbs[] = l($current->name, uc_catalog_term_path($current));
        $terms[] = $current->tid;
      }
    }
    //print '<pre>'. print_r($breadcrumbs, true) .'</pre>';
    return $breadcrumbs;
  }
  else{
    return null;
  }
}

/**
 * Displays links to all products that have not been categorized.
 */
function uc_catalog_orphaned_products() {
  $output = '<p>'. t('Orphaned products are products that you have created but 
     not yet assigned to a category in your product catalog. All such 
     products will appear as links below that you can follow to edit 
     the product listings to assign them to categories.') .'</p>';

  $query = "SELECT DISTINCT n.nid, n.title FROM {node} AS n LEFT JOIN {term_node} AS tn ON n.nid = tn.nid LEFT JOIN {vocabulary_node_types} AS vnt ON n.type = vnt.type WHERE n.type != 'image' AND tn.tid IS NULL AND vnt.vid = %d";
  $vid = variable_get('uc_catalog_vid', 0);
  $result = db_query($query, $vid);

  $rows = array();
  while ($node = db_fetch_object($result)) {
    $rows[] = l($node->title, 'node/'. $node->nid .'/edit');
  }

  if (count($rows) > 0) {
    $output .= theme('item_list', $rows);
  }
  else{
    $output .= '<p>'. t('All products are currently listed in the catalog.') .'</p>';
  }

  return $output;
}

/**
 * Emulates Drupal's menu system, but based soley on the structure of "Product Catalog".
 *
 * @param $branch
 *   A treeNode as defined in uc_catalog_block. Determines if the URL points to itself,
 *   or possibly one of it's children, if present.
 *
 *   If the URL points to itself or one of it's products, it displays it's name, and
 *   expands to show it's children, otherwise displays a link and a count of the products in it.
 *   If the URL points to one of it's children, it still displays a link and product count,
 *   but must still be expanded.
 *   Otherwise, it is collapsed and a link.
 * @return
 *   An array whose first element is true if the treeNode is in hierarchy of the URL path.
 *   The second element is the HTML of the list item of itself and it's children.
 */
function _uc_catalog_navigation($branch){
  static $terms;
  
  $vid = variable_get('uc_catalog_vid', 0);
  if ($_GET['q'] ==  urldecode(uc_catalog_term_path($branch))){
    // The URL points to this term. Don't display as a link.
    $here = true;
  }
  else{
    $here = false;
  }
  if (!isset($terms)){
    $terms = taxonomy_node_get_terms_by_vocabulary(arg(1), $vid);
  }
  // Determine whether to expand menu item.
  if ((arg(0) == 'node' && array_key_exists($branch->tid, $terms))){
    $referer = drupal_get_normal_path(preg_replace('!^[^/]*//[^/]*'. preg_quote(base_path()) .'!', '', referer_uri(), 1));
    //drupal_set_message($referer ." == ". uc_catalog_term_path($branch));
    if ($referer == uc_catalog_term_path($branch)){
      $inpath = true;
    }
    else{
      $inpath = false;
    }
  }
  else{
    $inpath = $here;
  }
  //$result = db_query("SELECT type FROM {vocabulary_node_types} WHERE vid = %d", $vid);
  $types = uc_catalog_node_types();
  $num = 0;
  foreach ($types as $type){
    $num += taxonomy_term_count_nodes($branch->tid, $type);
  }
  if (!$num){ // No nodes in category or descendants. Not in path and display nothing.
    return array(false, '');
  }
  $link = l($branch->name .' ('. $num .')', uc_catalog_term_path($branch));
  if (count($branch->children)){
    $lis = array();
    foreach($branch->children as $twig){
      // Expand if children are in the menu path. Capture their output.
      list($child_in_path, $lis[]) = _uc_catalog_navigation($twig);
      if ($child_in_path){
        $inpath = $child_in_path;
      }
    }
    
    if ($here){
      $output = '<li class="expanded"><strong>'. $branch->name .' ('. $num .')' ."</strong>\n";
      $output .= '<ul class="menu">';
      foreach ($lis as $li){
        $output .= $li ."\n";
      }
      $output .= "</ul>\n</li>";
    }
    elseif ($inpath){
      $output = '<li class="expanded"><strong>'. $link ."</strong>\n";
      $output .= '<ul class="menu">';
      foreach ($lis as $li){
        $output .= $li;
      }
      $output .= "</ul>\n</li>";
    }
    else{
      $output = '<li class="collapsed">'. $link ."</li>\n";
    }
  }
  else{
    $output = '<li class="leaf">'. ($inpath ? '<strong>' : '') . ($here ? $branch->name .' ('. $num .')' : $link) . ($inpath ? '</strong>' : '') .'</li>'. "\n";
  }
  // Tell parent category your status, and pass on output.
  return array($inpath, $output);
}

function uc_catalog_image_load($term){
  if (is_object($term)){
    $tid = $term->tid;
  }
  else if (is_array($term)){
    $tid = $term['tid'];
  }
  else{
    $tid = $term;
  }
  
  $file = db_fetch_object(db_query("SELECT * FROM {uc_catalog_images} WHERE tid = %d", $tid));
  
  return $file;
}
